<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Cyber Kavach</title>
    <link rel="stylesheet" href="fire kavach/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>

<body>
    <header id="navbar">
        <div class="logo">üî• Cyber Kavach</div>
        <nav class="nav-links">
            <a href="dashboard.html">‚Üê Back to Dashboard</a>
        </nav>
    </header>

    <div class="profile-container">
        <div class="profile-card">
            <div class="alert success" id="success-alert"></div>
            <div class="alert error" id="error-alert"></div>

            <div class="profile-header">
                <div class="avatar-upload">
                    <div class="avatar-preview" id="avatar-preview">
                        <span id="avatar-initials">U</span>
                    </div>
                </div>
                <div class="header-info">
                    <h2 id="profile-name">Loading...</h2>
                    <p id="profile-email">Loading...</p>
                </div>
            </div>

            <form id="profile-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="name" id="name" placeholder="Enter your name">
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" disabled style="opacity: 0.6;">
                    </div>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" name="phone" id="phone" placeholder="+91 1234567890">
                    </div>

                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" name="company" id="company" placeholder="Your company name">
                    </div>

                    <div class="form-group full-width">
                        <label>Address</label>
                        <textarea name="address" id="address" placeholder="Enter your address"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="save-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        Cancel
                    </button>
                </div>
            </form>

            <h3 class="section-title">üîí Change Password</h3>

            <form id="password-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" name="currentPassword" placeholder="Enter current password">
                    </div>

                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" name="newPassword" placeholder="Enter new password" minlength="6">
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="password-btn">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001/api';
        const token = localStorage.getItem('auth-token');

        if (!token) {
            window.location.href = 'fire kavach/index.html';
        }

        const successAlert = document.getElementById('success-alert');
        const errorAlert = document.getElementById('error-alert');

        function showAlert(message, isSuccess) {
            if (isSuccess) {
                successAlert.innerText = message;
                successAlert.style.display = 'block';
                errorAlert.style.display = 'none';
            } else {
                errorAlert.innerText = message;
                errorAlert.style.display = 'block';
                successAlert.style.display = 'none';
            }

            setTimeout(() => {
                successAlert.style.display = 'none';
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Load user profile
        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/user/profile`, {
                    headers: { 'auth-token': token }
                });

                if (!res.ok) throw new Error('Failed to load profile');

                const user = await res.json();

                document.getElementById('profile-name').innerText = user.name || 'User';
                document.getElementById('profile-email').innerText = user.email || '';
                document.getElementById('name').value = user.name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('company').value = user.company || '';
                document.getElementById('address').value = user.address || '';

                // Set avatar initials
                const initials = (user.name || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                document.getElementById('avatar-initials').innerText = initials;

            } catch (error) {
                showAlert('Error loading profile', false);
            }
        }

        // Update profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                company: document.getElementById('company').value,
                address: document.getElementById('address').value
            };

            try {
                const res = await fetch(`${API_URL}/user/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'auth-token': token
                    },
                    body: JSON.stringify(formData)
                });

                const data = await res.json();

                if (res.ok) {
                    showAlert('Profile updated successfully!', true);

                    // Update local storage
                    let user = JSON.parse(localStorage.getItem('user') || '{}');
                    user.name = formData.name;
                    localStorage.setItem('user', JSON.stringify(user));

                    // Update display
                    document.getElementById('profile-name').innerText = formData.name;
                } else {
                    showAlert(data.message || 'Failed to update profile', false);
                }
            } catch (error) {
                showAlert('Error: Is backend running?', false);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        });

        // Change password
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const passwordBtn = document.getElementById('password-btn');
            const form = e.target;
            const currentPassword = form.currentPassword.value;
            const newPassword = form.newPassword.value;

            if (!currentPassword || !newPassword) {
                showAlert('Please fill all password fields', false);
                return;
            }

            passwordBtn.disabled = true;
            passwordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing...';

            try {
                const res = await fetch(`${API_URL}/user/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'auth-token': token
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await res.json();

                if (res.ok) {
                    showAlert('Password changed successfully!', true);
                    form.reset();
                } else {
                    showAlert(data.message || 'Failed to change password', false);
                }
            } catch (error) {
                showAlert('Error: Is backend running?', false);
            } finally {
                passwordBtn.disabled = false;
                passwordBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
            }
        });

        // Load profile on page load
        loadProfile();
    </script>
</body>

</html>